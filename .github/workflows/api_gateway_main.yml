name: Build & Push API Gateway Docker Image

on:
  push:
    branches:
      - main

env:
  DOCKER_IMAGE: petlog
  SERVICE_NAME: api-gateway

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Source Checkout
      - name: Checkout source
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ JDK 17 ÏÑ§Ï†ï (JAR ÎπåÎìú)
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3Ô∏è‚É£ JAR ÎπåÎìú (ÌÖåÏä§Ìä∏ Ïä§ÌÇµ)
      - name: Build JAR (skip test)
        run: |
          chmod +x ./gradlew
          ./gradlew build -x test

      # 4Ô∏è‚É£ jq, curl ÏÑ§Ïπò
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      # 5Ô∏è‚É£ Docker Hub Î°úÍ∑∏Ïù∏ (docker CLIÏö©)
      - name: Docker login
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login \
            -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # 6Ô∏è‚É£ Docker Hub ÌÉúÍ∑∏ Ï°∞Ìöå + Î≤ÑÏ†Ñ Ï¶ùÍ∞Ä (‚≠ê ÌïµÏã¨)
      - name: Get latest apigateway tag and bump version
        id: bump
        run: |
          IMAGE=${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}
          SERVICE=${{ env.SERVICE_NAME }}

          echo "Fetching tags for $IMAGE ($SERVICE only)..."

          # üîë Private repo ÎåÄÏùë: curlÏóê Ïù∏Ï¶ù Ìè¨Ìï®
          TAGS=$(curl -s \
            -u "${{ secrets.DOCKER_USERNAME }}:${{ secrets.DOCKER_PASSWORD }}" \
            "https://hub.docker.com/v2/repositories/$IMAGE/tags/?page_size=1000" \
            | jq -r '.results // [] | .[].name')

          echo "Found tags:"
          echo "$TAGS"

          LATEST_VERSION=$(echo "$TAGS" \
            | grep "^${SERVICE}-[0-9]\+\.[0-9]\+$" \
            | sed "s/^${SERVICE}-//" \
            | sort -V \
            | tail -n 1)

          if [ -z "$LATEST_VERSION" ]; then
            NEW_VERSION="0.1"
          else
            MAJOR=$(echo "$LATEST_VERSION" | cut -d. -f1)
            MINOR=$(echo "$LATEST_VERSION" | cut -d. -f2)
            MINOR=$((MINOR + 1))
            NEW_VERSION="${MAJOR}.${MINOR}"
          fi

          NEW_TAG="${SERVICE}-${NEW_VERSION}"

          echo "Latest version: $LATEST_VERSION"
          echo "New tag: $NEW_TAG"

          echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT

      # 7Ô∏è‚É£ Docker Build & Push
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ steps.bump.outputs.tag }}
            ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ env.SERVICE_NAME }}-latest

      # 8Ô∏è‚É£ ÏôÑÎ£å Î°úÍ∑∏
      - name: Done
        run: |
          echo "Docker image pushed successfully!!"
          echo " - ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ steps.bump.outputs.tag }}"
          echo " - ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ env.SERVICE_NAME }}-latest"
