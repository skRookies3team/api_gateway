name: Build & Push API Gateway Docker Image

on:
  push:
    branches:
      - main

env:
  DOCKER_IMAGE: petlog
  SERVICE_NAME: api-gateway

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # source Checkout 
      - name: Checkout source
        uses: actions/checkout@v4

      # JDK 17 설정 (JAR 빌드용)
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # JAR 생성 (skip test)
      - name: Build JAR (skip test)
        run: |
          chmod +x ./gradlew
          ./gradlew build -x test

      # jq, curl 설치 (Docker Hub 태그 조회용)
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      # Docker Hub 로그인 (태그 조회보다 먼저)
      - name: Docker login
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login \
            -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # Docker Hub에서 api-gateway 태그만 조회 후 버전 증가
      - name: Get latest apigateway tag and bump version
        id: bump
        run: |
          IMAGE=${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}
          SERVICE=${{ env.SERVICE_NAME }}

          echo "Fetching tags for $IMAGE ($SERVICE only)..."

          # results가 없거나 null이어도 죽지 않게 방어
          TAGS=$(curl -s "https://hub.docker.com/v2/repositories/$IMAGE/tags/?page_size=1000" \
            | jq -r '.results // [] | .[].name')

          echo "Found tags:"
          echo "$TAGS"

          LATEST_VERSION=$(echo "$TAGS" \
            | grep "^${SERVICE}-[0-9]\+\.[0-9]\+$" \
            | sed "s/^${SERVICE}-//" \
            | sort -V \
            | tail -n 1)

          if [ -z "$LATEST_VERSION" ]; then
            NEW_VERSION="0.1"
          else
            MAJOR=$(echo "$LATEST_VERSION" | cut -d. -f1)
            MINOR=$(echo "$LATEST_VERSION" | cut -d. -f2)

            if [ "$MINOR" -eq 9 ]; then
              MAJOR=$((MAJOR + 1))
              MINOR=0
            else
              MINOR=$((MINOR + 1))
            fi

            NEW_VERSION="${MAJOR}.${MINOR}"
          fi

          NEW_TAG="${SERVICE}-${NEW_VERSION}"

          echo "Latest version: $LATEST_VERSION"
          echo "New tag: $NEW_TAG"

          echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT

      # Docker build & push
      # api-gateway-버전
      # api-gateway-latest
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ steps.bump.outputs.tag }}
            ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ env.SERVICE_NAME }}-latest

      # 완료 로그
      - name: Done
        run: |
          echo "Docker image pushed successfully!!"
          echo " - ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ steps.bump.outputs.tag }}"
          echo " - ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ env.SERVICE_NAME }}-latest"
